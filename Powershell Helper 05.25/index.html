<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PowerShell Cheat Sheet Bibliothek</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <style>
        :root {
            --bg: #151a20;
            --panel: #21252b;
            --card: #23282f;
            --text: #f7f7f7;
            --accent: #36ffe4;
            --border: #333c46;
        }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        .layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 310px;
            background: var(--panel);
            border-right: 1.5px solid var(--border);
            padding: 1.3em 1em 2em 1.5em;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
            position: sticky;
            top: 0;
        }
        .sidebar h2 {
            margin-top: 0; font-size: 1.13em; color: var(--accent); letter-spacing: 0.03em;
        }
        .toc-category, .toc-subcategory {
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            padding-left: 0.1em;
        }
        .toc-category {
            margin: 1.1em 0 0.4em;
            color: #87fff2;
            font-size: 1.07em;
            display: flex;
            align-items: center;
        }
        .toc-subcategory {
            margin: 0.13em 0 0.16em 0.6em;
            font-size: 0.99em;
            color: #70ded3;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .arrow {
            font-size: 1.18em;
            margin-right: 0.34em;
            transition: transform 0.18s;
            color: var(--accent);
        }
        .arrow.closed { transform: rotate(-90deg); }
        .arrow.open { transform: rotate(0deg);}
        .toc-entries { margin-left: 2.05em; }
        .toc-entry {
            margin: 0.18em 0;
            cursor: pointer;
            color: #b1f6ec;
            font-size: 0.99em;
            border-left: 2.5px solid transparent;
            transition: all 0.1s;
            padding-left: 0.39em;
            border-radius: 4px;
        }
        .toc-entry.selected, .toc-entry:hover {
            background: #26323a;
            border-left: 2.5px solid var(--accent);
            color: var(--accent);
        }
        .main {
            flex: 1;
            max-width: 950px;
            margin: 0 auto;
            padding: 2.5em 2.3em;
            box-sizing: border-box;
            min-height: 100vh;
        }
        h1 { margin-top: 0; color: var(--accent); letter-spacing: 0.01em; }
        .searchbar {
            width: 100%; background: var(--card); border: 1px solid var(--border);
            color: var(--text); font-size: 1.15em;
            border-radius: 9px; padding: 0.7em 1em; margin-bottom: 2em;
            margin-top: 0.2em;
        }
        .entry {
            background: var(--card);
            border-radius: 13px;
            box-shadow: 0 2px 16px #0003;
            padding: 1.9em 1.3em 1.3em;
            margin-bottom: 1.2em;
            border: 1.5px solid var(--border);
        }
        .category {
            display: inline-block; background: #21725b; color: #a2ffed;
            border-radius: 6px; padding: 0.15em 0.7em; font-size: 0.96em; margin-bottom: 0.7em;
            letter-spacing: 0.01em;
        }
        .subcategory {
            display: inline-block; background: #172742; color: #55f1ea;
            border-radius: 6px; padding: 0.13em 0.7em; font-size: 0.94em; margin-bottom: 0.7em;
            letter-spacing: 0.01em;
            margin-left: 0.4em;
        }
        .tags { margin: 0.7em 0; }
        .tag {
            display: inline-block; background: #384e56; color: #78e0c2;
            border-radius: 6px; padding: 0.22em 0.8em; font-size: 0.88em; margin-right: 0.38em;
        }
        .multi-codes { margin-top: 1.2em;}
        .code-block {
    margin-bottom: 1.6em;
    margin-top: 0.3em;
}
.code-block {
    margin-bottom: 1.6em;
    margin-top: 0.3em;
}
.code-description {
    color: #aeefff;
    font-size: 0.97em;
    margin-bottom: 0.25em;
    margin-left: 0.17em;
    font-style: italic;
}
.code-pre {
    background: #141c22 !important;
    border-radius: 8px;
    position: relative;
    padding-top: 1.4em !important;
    /* Damit oben Platz f√ºr den Button ist */
}
button.copy-btn {
    position: absolute;
    top: 0.38em;
    right: 0.9em;
    background: #2c3641;
    border: 1px solid #3f4a58;
    color: #94ffe7;
    border-radius: 7px;
    cursor: pointer;
    padding: 3px 13px;
    font-size: 1em;
    transition: background 0.12s;
    z-index: 2;
    /* Optional: Schatten f√ºr bessere Sichtbarkeit */
    box-shadow: 0 2px 8px #0004;
}
button.copy-btn:hover { background: #28383a; }

button.copy-btn:hover { background: #28383a; }
        pre { background: #141c22 !important; border-radius: 8px; }
        @media (max-width: 800px) {
            .sidebar { width: 170px; font-size: 0.92em; padding: 1em 0.4em 1em 0.4em;}
            .main { padding: 1.2em 0.7em; }
        }
        @media (max-width: 600px) {
            .layout { flex-direction: column; }
            .sidebar { position: static; width: 100vw; min-height: unset; }
        }
    </style>
</head>
<body>
<div class="layout">
    <div class="sidebar">
        <h2>Inhaltsverzeichnis</h2>
        <div id="toc"></div>
    </div>
    <div class="main">
        <h1>PowerShell Cheat Sheet</h1>
        <input class="searchbar" type="text" id="searchInput" placeholder="üîç Suchen... Problem, Kategorie, Subkategorie, Tag ...">
        <div id="cheatsheet"></div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script>
let entries = [];
let filteredEntries = [];
let toc = {}; // {category: {subcategory: [indices]}}
let currentIndex = null;
let tocState = {}; // Speichert aufgeklappte Zust√§nde

fetch('powershell_cheatsheet_entries.json')
    .then(resp => resp.json())
    .then(data => {
        entries = data;
        buildTOC(entries);
        filteredEntries = entries;
        renderTOC();
        showEntry(0);
    });

// TOC mit Subkategorien bauen
function buildTOC(entryList) {
    toc = {};
    tocState = {};
    entryList.forEach((e, i) => {
        const cat = e.category || "Allgemein";
        const sub = e.subcategory || "Allgemein";
        if (!toc[cat]) toc[cat] = {};
        if (!toc[cat][sub]) toc[cat][sub] = [];
        toc[cat][sub].push(i);
    });
    // Initial: alles zugeklappt
    Object.keys(toc).forEach(cat => {
        if (tocState[cat] === undefined) tocState[cat] = false;
        Object.keys(toc[cat]).forEach(sub => {
            if (tocState[cat + '|' + sub] === undefined) tocState[cat + '|' + sub] = false;
        });
    });
}

function renderTOC() {
    const tocDiv = document.getElementById('toc');
    tocDiv.innerHTML = "";
    Object.keys(toc).sort().forEach(category => {
        // Kategorie-Header mit Arrow
        const catOpen = tocState[category];
        tocDiv.innerHTML += `<div class="toc-category" onclick="toggleTOC('${category}')">
            <span class="arrow ${catOpen ? 'open' : 'closed'}">&#9654;</span> ${category}
        </div>`;
        if (catOpen) {
            const subs = toc[category];
            Object.keys(subs).sort().forEach(sub => {
                const subKey = category + '|' + sub;
                const subOpen = tocState[subKey];
                tocDiv.innerHTML += `<div class="toc-subcategory" onclick="toggleTOC('${category}','${sub}');event.stopPropagation();">
                    <span class="arrow ${subOpen ? 'open' : 'closed'}">&#9654;</span> ${sub}
                </div>`;
                if (subOpen) {
                    tocDiv.innerHTML += `<div class="toc-entries">`;
                    subs[sub].forEach(idx => {
                        const selected = (idx === currentIndex) ? 'selected' : '';
                        tocDiv.innerHTML += `<div class="toc-entry ${selected}" onclick="showEntry(${idx});event.stopPropagation();">${entries[idx].title}</div>`;
                    });
                    tocDiv.innerHTML += `</div>`;
                }
            });
        }
    });
}

window.toggleTOC = function(category, subcategory) {
    if (subcategory === undefined) {
        tocState[category] = !tocState[category];
    } else {
        tocState[category + '|' + subcategory] = !tocState[category + '|' + subcategory];
    }
    renderTOC();
};

// Einzelnen Cheat-Eintrag anzeigen
function showEntry(idx) {
    currentIndex = idx;
    renderTOC();
    document.getElementById('searchInput').value = "";
    renderEntry(entries[idx]);
}

function renderEntry(entry) {
    const sheet = document.getElementById('cheatsheet');
    if (!entry) {
        sheet.innerHTML = '<div class="entry"><b>Kein Eintrag gefunden.</b></div>';
        return;
    }

    // Bereite alle Codebl√∂cke vor (Multi oder Single)
    let codes = '';
    if (Array.isArray(entry.solution)) {
        codes = entry.solution.map(sol =>
            `
            <div class="code-block">
                ${sol.description ? `<div class="code-description">${sol.description}</div>` : ''}
                <pre class="code-pre">
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <code class="${sol.language}">${(sol.code||'').replace(/</g, "&lt;")}</code>
                </pre>
            </div>
            `
        ).join('');
    } else if (entry.solution && entry.solution.code) {
        codes = `
            <div class="code-block">
                ${entry.solution.description ? `<div class="code-description">${entry.solution.description}</div>` : ''}
                <pre class="code-pre">
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <code class="${entry.solution.language}">${(entry.solution.code||'').replace(/</g, "&lt;")}</code>
                </pre>
            </div>
        `;
    }

    sheet.innerHTML = `
        <div class="entry">
            <div>
                <span class="category">${entry.category || ""}</span>
                <span class="subcategory">${entry.subcategory || ""}</span>
            </div>
            <h2>${entry.title}</h2>
            <div class="tags">${(entry.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ')}</div>
            <p><b>Problem:</b> ${entry.problem}</p>
            <p><b>Erkl√§rung:</b> ${entry.explanation}</p>
            <div class="multi-codes">
                ${codes}
            </div>
        </div>
    `;
    document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
}


// Suche & Inhaltsverzeichnis kombinieren
document.getElementById('searchInput').addEventListener('input', function(e) {
    const value = e.target.value.toLowerCase();
    if (!value.trim()) {
        entries = filteredEntries = window.entriesOriginal || entries;
        buildTOC(entries);
        renderTOC();
        showEntry(currentIndex || 0);
        return;
    }
    // Filtere alle Eintr√§ge nach allen Feldern
    filteredEntries = entries.filter(entry =>
        (entry.title || "").toLowerCase().includes(value) ||
        (entry.problem || "").toLowerCase().includes(value) ||
        (entry.category || "").toLowerCase().includes(value) ||
        (entry.subcategory || "").toLowerCase().includes(value) ||
        (entry.tags || []).join(' ').toLowerCase().includes(value)
    );
    if (!window.entriesOriginal) window.entriesOriginal = entries;
    entries = filteredEntries;
    buildTOC(entries);
    renderTOC();
    showEntry(filteredEntries.length ? 0 : null);
});

function copyCode(btn) {
    const code = btn.parentElement.querySelector('code').innerText;
    navigator.clipboard.writeText(code);
    btn.textContent = "‚úì Kopiert!";
    setTimeout(() => btn.textContent = "Copy", 1200);
}
</script>
</body>
</html>
